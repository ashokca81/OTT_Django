{% extends 'base.html' %}
{% load static %}

{% block title %}Normal Users Dashboard - OTT Admin{% endblock %}

{% block content %}
{% include 'includes/sidebar.html' %}

    <!-- Main Content -->
    <main class="main-content flex-1 p-6 overflow-auto">
        {% include 'includes/header.html'%}
        <div class="flex-1 overflow-x-hidden overflow-y-auto">
        
        <!-- Main Content Area -->
        <main class="p-6">
            <!-- Filters and Search -->
            <div class="mb-6 flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-4 w-full">
                    <div class="w-full">
                        <input type="text" 
                               id="searchInput" 
                               placeholder="Search users..." 
                               class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="w-full">
                        <select id="statusFilter" 
                                class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="w-full">
                        <select id="subscriptionFilter" 
                                class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">All Subscriptions</option>
                            <option value="active">Active Subscription</option>
                            <option value="expired">Expired Subscription</option>
                            <option value="none">No Subscription</option>
                        </select>
                    </div>
                    <div class="w-full">
                        <select id="pageSizeFilter" 
                                class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" 
                                onchange="changePageSize(this.value)">
                            <option value="5" {% if page_size == '5' %}selected{% endif %}>5 per page</option>
                            <option value="10" {% if page_size == '10' %}selected{% endif %}>10 per page</option>
                            <option value="20" {% if page_size == '20' %}selected{% endif %}>20 per page</option>
                            <option value="50" {% if page_size == '50' %}selected{% endif %}>50 per page</option>
                            <option value="75" {% if page_size == '75' %}selected{% endif %}>75 per page</option>
                            <option value="all" {% if page_size == 'all' %}selected{% endif %}>Show All</option>
                        </select>
                    </div>
                    <div class="w-full sm:col-span-2 xl:col-span-2 flex space-x-2">
                        <button onclick="exportToExcel()" 
                                class="flex-1 px-4 py-2 bg-green-500 text-white text-sm rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 whitespace-nowrap">
                            <i class="fas fa-file-excel mr-2"></i>Export Excel
                        </button>
                        <button onclick="exportToPDF()" 
                                class="flex-1 px-4 py-2 bg-red-500 text-white text-sm rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 whitespace-nowrap">
                            <i class="fas fa-file-pdf mr-2"></i>Export PDF
                        </button>
                    </div>
                </div>
            </div>

            <!-- Users Table -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="overflow-x-auto" style="max-height: 600px;">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact Info</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subscription</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Referrals</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Joined Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky right-0 bg-gray-50">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for user in normal_users %}
                            <tr data-user-id="{{ user.id }}">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-10 w-10">
                                            {% if user.profile_picture %}
                                                <img class="h-10 w-10 rounded-full" src="{{ user.profile_picture.url }}" alt="">
                                            {% else %}
                                                <div class="h-10 w-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-medium">
                                                    {{ user.first_name|slice:":1"|upper }}{{ user.last_name|slice:":1"|upper }}
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="ml-4">
                                            <div class="text-sm font-medium text-gray-900">
                                                {% if user.first_name or user.last_name %}
                                                    {{ user.first_name }} {{ user.last_name }}
                                                {% else %}
                                                    {{ user.phone }}
                                                {% endif %}
                                            </div>
                                            <div class="text-sm text-gray-500">{{ user.referral.referral_code }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex flex-col">
                                        <div class="text-sm text-gray-900 font-medium">
                                            {{ user.phone }}
                                        </div>
                                        <div class="text-xs text-gray-500">
                                            {{ user.email }}
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex flex-col">
                                        <div class="text-sm text-gray-900 font-medium">
                                            {{ user.state_name }}
                                        </div>
                                        <div class="text-xs text-gray-500">
                                            {{ user.district_name }}
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span onclick="toggleUserStatus('{{ user.id }}', this)" 
                                          class="cursor-pointer px-2 inline-flex text-xs leading-5 font-semibold rounded-full transition-colors duration-200 {% if user.status == 'active' %}bg-green-100 text-green-800 hover:bg-green-200{% else %}bg-red-100 text-red-800 hover:bg-red-200{% endif %}">
                                        {{ user.status|title }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex flex-col">
                                        {% if user.current_plan %}
                                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800">
                                                {{ user.current_plan }}
                                            </span>
                                            <span class="text-xs text-gray-500 mt-1">
                                                Expires: {{ user.plan_end_date|date:"M d, Y" }}
                                            </span>
                                        {% else %}
                                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-600">
                                                No Active Plan
                                            </span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <span class="px-2 py-1 text-sm font-medium {% if user.referral_count > 0 %}bg-green-100 text-green-800 cursor-pointer hover:bg-green-200{% else %}bg-gray-100 text-gray-600{% endif %} rounded-full" {% if user.referral_count > 0 %}onclick="showReferralTree('{{ user.id }}')"{% endif %}>
                                            {{ user.referral_count }}
                                            <span class="text-xs ml-1">{% if user.referral_count == 1 %}referral{% else %}referrals{% endif %}</span>
                                        </span>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    {{ user.created_at|date:"M d, Y" }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium sticky right-0 bg-white">
                                    <div class="flex items-center space-x-3">
                                        <button onclick="viewUserDetails('{{ user.id }}')" class="text-green-600 hover:text-green-900">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button onclick="deleteUser('{{ user.id }}')" class="text-red-600 hover:text-red-900">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pagination -->
            <div class="mt-4 flex items-center justify-between bg-white px-4 py-3 sm:px-6 rounded-lg shadow">
                <div class="flex flex-1 justify-between sm:hidden">
                    {% if normal_users.has_previous %}
                    <a href="?page={{ normal_users.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}&page_size={{ page_size }}" 
                       class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        Previous
                    </a>
                    {% endif %}
                    {% if normal_users.has_next %}
                    <a href="?page={{ normal_users.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}&page_size={{ page_size }}" 
                       class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        Next
                    </a>
                    {% endif %}
                </div>
                <div class="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
                    <div>
                        <p class="text-sm text-gray-700">
                            Showing
                            <span class="font-medium">{{ normal_users.start_index }}</span>
                            to
                            <span class="font-medium">{{ normal_users.end_index }}</span>
                            of
                            <span class="font-medium">{{ normal_users.paginator.count }}</span>
                            results
                        </p>
                    </div>
                    <div>
                        <nav class="isolate inline-flex -space-x-px rounded-md shadow-sm" aria-label="Pagination">
                            {% if normal_users.has_previous %}
                            <a href="?page={{ normal_users.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}&page_size={{ page_size }}" 
                               class="relative inline-flex items-center rounded-l-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0">
                                <span class="sr-only">Previous</span>
                                <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" />
                                </svg>
                            </a>
                            {% endif %}

                            {% for i in normal_users.paginator.page_range %}
                                {% if normal_users.number == i %}
                                    <span class="relative z-10 inline-flex items-center bg-indigo-600 px-4 py-2 text-sm font-semibold text-white focus:z-20 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
                                        {{ i }}
                                    </span>
                                {% elif i > normal_users.number|add:"-3" and i < normal_users.number|add:"3" %}
                                    <a href="?page={{ i }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}&page_size={{ page_size }}" 
                                       class="relative inline-flex items-center px-4 py-2 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0">
                                        {{ i }}
                                    </a>
                                {% endif %}
                            {% endfor %}

                            {% if normal_users.has_next %}
                            <a href="?page={{ normal_users.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}&page_size={{ page_size }}" 
                               class="relative inline-flex items-center rounded-r-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0">
                                <span class="sr-only">Next</span>
                                <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
                                </svg>
                            </a>
                            {% endif %}
                        </nav>
                    </div>
                </div>
            </div>

            <!-- Add JavaScript for filtering -->
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const searchInput = document.getElementById('searchInput');
                    const statusFilter = document.getElementById('statusFilter');
                    const subscriptionFilter = document.getElementById('subscriptionFilter');
                    
                    // Add event listeners for all filters
                    searchInput.addEventListener('input', filterUsers);
                    statusFilter.addEventListener('change', filterUsers);
                    subscriptionFilter.addEventListener('change', filterUsers);
                    
                    function filterUsers() {
                        const searchTerm = searchInput.value.toLowerCase();
                        const statusValue = statusFilter.value.toLowerCase();
                        const subscriptionValue = subscriptionFilter.value.toLowerCase();
                        const rows = document.querySelectorAll('tbody tr');
                        
                        rows.forEach(row => {
                            // Get user data from row
                            const userName = row.querySelector('td:nth-child(1)').textContent.toLowerCase();
                            const phone = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                            const email = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                            const location = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
                            const status = row.querySelector('td:nth-child(4)').textContent.toLowerCase();
                            const subscriptionCell = row.querySelector('td:nth-child(5)');
                            const subscriptionText = subscriptionCell.textContent.toLowerCase();
                            
                            // Check if row matches search term
                            const matchesSearch = userName.includes(searchTerm) || 
                                                phone.includes(searchTerm) || 
                                                email.includes(searchTerm) || 
                                                location.includes(searchTerm);
                            
                            // Check if row matches status filter
                            const matchesStatus = statusValue === '' || status.includes(statusValue);
                            
                            // Check if row matches subscription filter
                            let matchesSubscription = true;
                            if (subscriptionValue !== '') {
                                switch(subscriptionValue) {
                                    case 'active':
                                        matchesSubscription = subscriptionText.includes('expires:') && 
                                                            !subscriptionCell.querySelector('.bg-gray-100');
                                        break;
                                    case 'expired':
                                        // Add logic for expired subscriptions if needed
                                        matchesSubscription = false;
                                        break;
                                    case 'none':
                                        matchesSubscription = subscriptionText.includes('no active plan');
                                        break;
                                }
                            }
                            
                            // Show/hide row based on all filters
                            row.style.display = (matchesSearch && matchesStatus && matchesSubscription) ? '' : 'none';
                        });

                        // Update the showing results text
                        updateResultsCount();
                    }

                    function updateResultsCount() {
                        const visibleRows = document.querySelectorAll('tbody tr:not([style*="display: none"])').length;
                        const totalRows = document.querySelectorAll('tbody tr').length;
                        const resultsText = document.querySelector('.text-sm.text-gray-700');
                        if (resultsText) {
                            resultsText.innerHTML = `Showing <span class="font-medium">${visibleRows}</span> of <span class="font-medium">${totalRows}</span> results`;
                        }
                    }

                    // Initial count update
                    updateResultsCount();
                });

                // Keep the existing changePageSize function
                function changePageSize(size) {
                    const currentUrl = new URL(window.location.href);
                    currentUrl.searchParams.set('page_size', size);
                    currentUrl.searchParams.delete('page'); // Reset to first page when changing page size
                    window.location.href = currentUrl.toString();
                }
            </script>
        </main>
        </div>
    </main>

    <!-- Referral Tree Modal -->
    <div id="referralTreeModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-1 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900" id="modalTitle">
                    Referral Network
                </h3>
                <button type="button" class="text-gray-400 hover:text-gray-500" onclick="closeReferralModal()">
                    <span class="sr-only">Close</span>
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <!-- Tree Container -->
            <div class="overflow-hidden border rounded-lg">
                <div class="flex items-center justify-end space-x-2 p-2 bg-gray-50 border-b">
                    <button onclick="zoomIn()" class="p-1 hover:bg-gray-200 rounded">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                    </button>
                    <button onclick="zoomOut()" class="p-1 hover:bg-gray-200 rounded">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
                        </svg>
                    </button>
                    <button onclick="resetZoom()" class="p-1 hover:bg-gray-200 rounded">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                    </button>
                </div>
                <div id="referralTreeContainer" class="w-full" style="height: 70vh;">
                    <!-- Tree will be rendered here -->
                </div>
            </div>

            <!-- Legend -->
            <div class="mt-4 flex items-center space-x-4 text-sm">
                <div class="flex items-center">
                    <span class="w-3 h-3 rounded-full bg-green-500 mr-2"></span>
                    <span>Active Users</span>
                </div>
                <div class="flex items-center">
                    <span class="w-3 h-3 rounded-full bg-gray-400 mr-2"></span>
                    <span>Inactive Users</span>
                </div>
                <div class="flex items-center">
                    <span class="w-3 h-3 rounded-full bg-blue-500 mr-2"></span>
                    <span>Selected User</span>
                </div>
            </div>

            <!-- Stats Summary -->
            <div class="mt-4 grid grid-cols-3 gap-4 p-4 bg-gray-50 rounded-lg">
                <div class="text-center">
                    <div class="text-sm font-medium text-gray-500">Total Referrals</div>
                    <div class="text-xl font-semibold text-gray-900" id="totalReferrals">0</div>
                </div>
                <div class="text-center">
                    <div class="text-sm font-medium text-gray-500">Active Referrals</div>
                    <div class="text-xl font-semibold text-green-600" id="activeReferrals">0</div>
                </div>
                <div class="text-center">
                    <div class="text-sm font-medium text-gray-500">Network Depth</div>
                    <div class="text-xl font-semibold text-blue-600" id="networkDepth">0</div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Details Modal -->
    <div id="userDetailsModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-2 mx-auto p-6 border w-11/12 max-w-4xl shadow-lg rounded-lg bg-white">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-2xl font-bold text-gray-900" id="userDetailsTitle"></h3>
                <button type="button" class="text-gray-400 hover:text-gray-500" onclick="closeUserDetailsModal()">
                    <span class="sr-only">Close</span>
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div class="grid grid-cols-12 gap-6">
                <!-- User Profile Section -->
                <div class="col-span-12 md:col-span-4">
                    <div class="bg-white p-4 rounded-lg shadow-sm border">
                        <div class="flex flex-col items-center">
                            <div id="userProfilePic" class="w-32 h-32 rounded-full bg-blue-500 flex items-center justify-center text-white text-3xl font-bold mb-4">
                            </div>
                            <h4 id="userName" class="text-xl font-semibold mb-2"></h4>
                            <span id="userStatus" class="px-3 py-1 rounded-full text-sm font-semibold"></span>
                            <div class="w-full mt-4 space-y-2">
                                <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                    <span class="text-sm text-gray-500">Member Since</span>
                                    <span id="userJoinDate" class="text-sm font-medium"></span>
                                </div>
                                <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                    <span class="text-sm text-gray-500">Referral Code</span>
                                    <span id="userReferralCode" class="text-sm font-medium"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact & Location Info -->
                <div class="col-span-12 md:col-span-8">
                    <div class="grid grid-cols-1 gap-4">
                        <!-- Contact Information -->
                        <div class="bg-white p-4 rounded-lg shadow-sm border">
                            <h5 class="text-lg font-semibold mb-4 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                </svg>
                                Contact Information
                            </h5>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="space-y-1">
                                    <label class="text-sm text-gray-500">Phone Number</label>
                                    <p id="userPhone" class="font-medium"></p>
                                </div>
                                <div class="space-y-1">
                                    <label class="text-sm text-gray-500">Email Address</label>
                                    <p id="userEmail" class="font-medium"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Location Information -->
                        <div class="bg-white p-4 rounded-lg shadow-sm border">
                            <h5 class="text-lg font-semibold mb-4 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                Location Details
                            </h5>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="space-y-1">
                                    <label class="text-sm text-gray-500">State</label>
                                    <p id="userState" class="font-medium"></p>
                                </div>
                                <div class="space-y-1">
                                    <label class="text-sm text-gray-500">District</label>
                                    <p id="userDistrict" class="font-medium"></p>
                                </div>
                                <div class="space-y-1">
                                    <label class="text-sm text-gray-500">Mandal</label>
                                    <p id="userMandal" class="font-medium"></p>
                                </div>
                                <div class="space-y-1">
                                    <label class="text-sm text-gray-500">Village</label>
                                    <p id="userVillage" class="font-medium"></p>
                                </div>
                                <div class="space-y-1">
                                    <label class="text-sm text-gray-500">Address</label>
                                    <p id="userAddress" class="font-medium break-words"></p>
                                </div>
                                <div class="space-y-1">
                                    <label class="text-sm text-gray-500">Pincode</label>
                                    <p id="userPincode" class="font-medium"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Referral Statistics -->
                <div class="col-span-12">
                    <div class="bg-white p-4 rounded-lg shadow-sm border">
                        <h5 class="text-lg font-semibold mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                            </svg>
                            Referral Statistics
                        </h5>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-green-50 p-4 rounded-lg">
                                <div class="text-sm text-green-600 mb-1">Total Referrals</div>
                                <div id="userTotalReferrals" class="text-2xl font-bold text-green-700"></div>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <div class="text-sm text-blue-600 mb-1">Active Referrals</div>
                                <div id="userActiveReferrals" class="text-2xl font-bold text-blue-700"></div>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-lg cursor-pointer hover:bg-purple-100 transition-colors" onclick="showReferralTreeFromDepth('{{ user.id }}')">
                                <div class="text-sm text-purple-600 mb-1">Network Depth</div>
                                <div id="userNetworkDepth" class="text-2xl font-bold text-purple-700"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Information -->
                <div class="col-span-12">
                    <div class="bg-white p-4 rounded-lg shadow-sm border">
                        <h5 class="text-lg font-semibold mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                            </svg>
                            Payment Information
                        </h5>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Current Plan Details -->
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h6 class="text-sm font-semibold text-gray-700 mb-3">Current Plan Details</h6>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">Plan Name</span>
                                        <span id="userCurrentPlan" class="font-medium text-gray-900">-</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">Start Date</span>
                                        <span id="userPlanStartDate" class="font-medium text-gray-900">-</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">End Date</span>
                                        <span id="userPlanEndDate" class="font-medium text-gray-900">-</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">Status</span>
                                        <span id="userPlanStatus" class="px-2 py-1 text-xs font-medium rounded-full">-</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Payment History -->
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h6 class="text-sm font-semibold text-gray-700 mb-3">Recent Payments</h6>
                                <div id="userPaymentHistory" class="space-y-3">
                                    <!-- Payment history items will be inserted here -->
                                </div>
                            </div>

                            <!-- Payment Statistics -->
                            <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <div class="text-sm text-green-600 mb-1">Total Amount Paid</div>
                                    <div id="userTotalPaid" class="text-2xl font-bold text-green-700">₹0</div>
                                </div>
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <div class="text-sm text-blue-600 mb-1">Last Payment</div>
                                    <div id="userLastPayment" class="text-2xl font-bold text-blue-700">₹0</div>
                                </div>
                                <div class="bg-yellow-50 p-4 rounded-lg">
                                    <div class="text-sm text-yellow-600 mb-1">Payment Due</div>
                                    <div id="userPaymentDue" class="text-2xl font-bold text-yellow-700">₹0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Activity Timeline -->
                <div class="col-span-12">
                    <div class="bg-white p-4 rounded-lg shadow-sm border">
                        <h5 class="text-lg font-semibold mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Recent Activity
                        </h5>
                        <div id="userActivityTimeline" class="space-y-4">
                            <!-- Activity items will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
let svg, g;
let zoom;

// Add search and filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    
    // Add event listeners for search and filter
    searchInput.addEventListener('input', filterUsers);
    statusFilter.addEventListener('change', filterUsers);
    
    function filterUsers() {
        const searchTerm = searchInput.value.toLowerCase();
        const statusValue = statusFilter.value.toLowerCase();
        const rows = document.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
            // Get user data from row
            const userName = row.querySelector('td:nth-child(1)').textContent.toLowerCase();
            const phone = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
            const email = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
            const location = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
            const status = row.querySelector('td:nth-child(4)').textContent.toLowerCase();
            
            // Check if row matches both search term and status filter
            const matchesSearch = userName.includes(searchTerm) || 
                                phone.includes(searchTerm) || 
                                email.includes(searchTerm) || 
                                location.includes(searchTerm);
                                
            const matchesStatus = statusValue === '' || status.includes(statusValue);
            
            // Show/hide row based on filters
            row.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
        });
    }
});

function showReferralTree(userId) {
    // Show modal
    document.getElementById('referralTreeModal').classList.remove('hidden');
    
    // Fetch referral data
    fetch(`/api/users/${userId}/referral-tree/`)
        .then(response => response.json())
        .then(data => {
            renderReferralTree(data);
            updateReferralStats(data);
        });
}

function closeReferralModal() {
    document.getElementById('referralTreeModal').classList.add('hidden');
}

function renderReferralTree(data) {
    const container = document.getElementById('referralTreeContainer');
    container.innerHTML = ''; // Clear previous content
    
    const width = container.offsetWidth;
    const height = container.offsetHeight;
    
    // Create SVG with zoom support
    svg = d3.select('#referralTreeContainer')
        .append('svg')
        .attr('width', '100%')
        .attr('height', '100%')
        .attr('viewBox', [0, 0, width, height])
        .style('background', '#f8fafc'); // Light background
    
    // Add gradient definitions
    const defs = svg.append('defs');
    
    // Gradient for active nodes
    const activeGradient = defs.append('linearGradient')
        .attr('id', 'activeGradient')
        .attr('x1', '0%')
        .attr('y1', '0%')
        .attr('x2', '0%')
        .attr('y2', '100%');
    
    activeGradient.append('stop')
        .attr('offset', '0%')
        .attr('style', 'stop-color:#4ade80;stop-opacity:1');
    
    activeGradient.append('stop')
        .attr('offset', '100%')
        .attr('style', 'stop-color:#22c55e;stop-opacity:1');
    
    // Gradient for inactive nodes
    const inactiveGradient = defs.append('linearGradient')
        .attr('id', 'inactiveGradient')
        .attr('x1', '0%')
        .attr('y1', '0%')
        .attr('x2', '0%')
        .attr('y2', '100%');
    
    inactiveGradient.append('stop')
        .attr('offset', '0%')
        .attr('style', 'stop-color:#94a3b8;stop-opacity:1');
    
    inactiveGradient.append('stop')
        .attr('offset', '100%')
        .attr('style', 'stop-color:#64748b;stop-opacity:1');
    
    // Add zoom behavior
    g = svg.append('g');
    zoom = d3.zoom()
        .scaleExtent([0.1, 3])
        .on('zoom', (event) => {
            g.attr('transform', event.transform);
        });
    svg.call(zoom);
    
    // Create tree layout (vertical orientation)
    const treeLayout = d3.tree()
        .size([width - 150, height - 150])
        .separation((a, b) => (a.parent == b.parent ? 2.5 : 3.5));
    
    // Create root node and calculate tree data
    const root = d3.hierarchy(data);
    const treeData = treeLayout(root);
    
    // Create curved links
    const links = g.selectAll('path.link')
        .data(treeData.links())
        .enter()
        .append('path')
        .attr('class', 'link')
        .attr('fill', 'none')
        .attr('stroke', '#e2e8f0')
        .attr('stroke-width', 2)
        .attr('d', d3.linkVertical()
            .x(d => d.x)
            .y(d => d.y))
        .style('opacity', 0)
        .transition()
        .duration(800)
        .style('opacity', 1);
    
    // Create node groups with animation
    const nodes = g.selectAll('g.node')
        .data(treeData.descendants())
        .enter()
        .append('g')
        .attr('class', 'node')
        .attr('transform', d => `translate(${d.x},${d.y})`)
        .style('opacity', 0)
        .transition()
        .duration(800)
        .delay((d, i) => i * 100)
        .style('opacity', 1);
    
    // Add level backgrounds
    nodes.selection()
        .append('circle')
        .attr('r', 35)
        .attr('fill', '#f1f5f9')
        .attr('stroke', '#e2e8f0')
        .attr('stroke-width', 2)
        .style('opacity', 0.5);
    
    // Add node circles with enhanced hover effect
    nodes.selection()
        .append('circle')
        .attr('r', 30)
        .attr('fill', d => d.data.is_active ? 'url(#activeGradient)' : 'url(#inactiveGradient)')
        .attr('stroke', d => d.data.is_selected ? '#3b82f6' : '#fff')
        .attr('stroke-width', 3)
        .style('filter', 'drop-shadow(0 4px 6px rgba(0,0,0,0.1))')
        .style('cursor', 'pointer')
        .on('mouseover', function(event, d) {
            d3.select(this)
                .transition()
                .duration(200)
                .attr('r', 35)
                .style('filter', 'drop-shadow(0 6px 8px rgba(0,0,0,0.2))');
            
            // Show tooltip with enhanced design
            const tooltip = d3.select('#treeTooltip');
            tooltip.transition()
                .duration(200)
                .style('opacity', .95);
            tooltip.html(`
                <div class="bg-white p-4 rounded-xl shadow-xl border border-gray-100">
                    <div class="flex items-center mb-3">
                        <div class="w-10 h-10 rounded-full ${d.data.is_active ? 'bg-green-500' : 'bg-gray-500'} flex items-center justify-center text-white font-bold text-lg">
                            ${d.data.first_name.charAt(0)}${d.data.last_name.charAt(0)}
                        </div>
                        <div class="ml-3">
                            <div class="font-bold text-gray-900">${d.data.first_name} ${d.data.last_name}</div>
                            <div class="text-sm text-gray-500">Level ${d.depth}</div>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <div class="flex items-center text-sm">
                            <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                            </svg>
                            ${d.data.phone}
                        </div>
                        <div class="flex items-center text-sm">
                            <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                            </svg>
                            ${d.data.email}
                        </div>
                        <div class="flex items-center text-sm">
                            <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            Joined: ${d.data.joined_date}
                        </div>
                        <div class="flex items-center text-sm">
                            <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                            </svg>
                            Direct Referrals: ${d.data.referral_count}
                        </div>
                        <div class="mt-2 pt-2 border-t border-gray-100">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                                d.data.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'
                            }">
                                ${d.data.is_active ? 'Active' : 'Inactive'}
                            </span>
                        </div>
                    </div>
                </div>
            `)
            .style('left', (event.pageX + 10) + 'px')
            .style('top', (event.pageY - 28) + 'px');
        })
        .on('mouseout', function() {
            d3.select(this)
                .transition()
                .duration(200)
                .attr('r', 30)
                .style('filter', 'drop-shadow(0 4px 6px rgba(0,0,0,0.1))');
            
            d3.select('#treeTooltip')
                .transition()
                .duration(500)
                .style('opacity', 0);
        });
    
    // Add user initials
    nodes.selection()
        .append('text')
        .attr('text-anchor', 'middle')
        .attr('dy', '0.3em')
        .attr('fill', 'white')
        .attr('font-size', '16px')
        .style('font-weight', 'bold')
        .text(d => `${d.data.first_name.charAt(0)}${d.data.last_name.charAt(0)}`);
    
    // Add user name labels
    nodes.selection()
        .append('text')
        .attr('text-anchor', 'middle')
        .attr('dy', '45px')
        .attr('fill', '#1f2937')
        .attr('font-size', '12px')
        .style('font-weight', '500')
        .text(d => `${d.data.first_name} ${d.data.last_name}`);
    
    // Add level badges
    const levelBadges = nodes.selection()
        .append('g')
        .attr('transform', 'translate(0, -45)');
    
    levelBadges.append('rect')
        .attr('x', -25)
        .attr('y', -12)
        .attr('width', 50)
        .attr('height', 20)
        .attr('rx', 10)
        .attr('fill', '#e2e8f0')
        .attr('opacity', 0.9);
    
    levelBadges.append('text')
        .attr('text-anchor', 'middle')
        .attr('dy', '0.3em')
        .attr('fill', '#475569')
        .attr('font-size', '11px')
        .style('font-weight', '500')
        .text(d => `Level ${d.depth}`);
    
    // Add referral count badges with enhanced design
    const badges = nodes.selection()
        .filter(d => d.data.referral_count > 0)
        .append('g')
        .attr('transform', 'translate(25, -25)');
    
    badges.append('circle')
        .attr('r', 12)
        .attr('fill', '#3b82f6')
        .style('filter', 'drop-shadow(0 2px 4px rgba(59,130,246,0.3))');
    
    badges.append('text')
        .attr('text-anchor', 'middle')
        .attr('dy', '0.3em')
        .attr('fill', 'white')
        .attr('font-size', '11px')
        .style('font-weight', 'bold')
        .text(d => d.data.referral_count);
    
    // Center the initial view with animation
    centerView(true);
}

function centerView(animate = false) {
    const bounds = g.node().getBBox();
    const parent = g.node().parentElement;
    const fullWidth = parent.clientWidth;
    const fullHeight = parent.clientHeight;
    const width = bounds.width;
    const height = bounds.height;
    const midX = bounds.x + width / 2;
    const midY = bounds.y + height / 2;
    
    const scale = 0.8 / Math.max(width / fullWidth, height / fullHeight);
    const translate = [fullWidth / 2 - scale * midX, fullHeight / 2 - scale * midY];
    
    if (animate) {
        svg.transition()
            .duration(750)
            .call(
                zoom.transform,
                d3.zoomIdentity
                    .translate(translate[0], translate[1])
                    .scale(scale)
            );
    } else {
        svg.call(
            zoom.transform,
            d3.zoomIdentity
                .translate(translate[0], translate[1])
                .scale(scale)
        );
    }
}

// Add tooltip container with enhanced styling
if (!document.getElementById('treeTooltip')) {
    const tooltipDiv = document.createElement('div');
    tooltipDiv.id = 'treeTooltip';
    tooltipDiv.style.position = 'absolute';
    tooltipDiv.style.opacity = '0';
    tooltipDiv.style.pointerEvents = 'none';
    tooltipDiv.style.zIndex = '1000';
    tooltipDiv.style.maxWidth = '300px';
    document.body.appendChild(tooltipDiv);
}

function updateReferralStats(data) {
    // Calculate statistics
    let totalReferrals = 0;
    let activeReferrals = 0;
    let maxDepth = 0;
    
    function traverse(node, depth = 0) {
        if (depth > 0) { // Don't count the root node
            totalReferrals++;
            if (node.is_active) {
                activeReferrals++;
            }
        }
        maxDepth = Math.max(maxDepth, depth);
        
        if (node.children && node.children.length > 0) {
            node.children.forEach(child => traverse(child, depth + 1));
        }
    }
    
    traverse(data, 0);
    
    // Update stats in UI
    document.getElementById('totalReferrals').textContent = totalReferrals;
    document.getElementById('activeReferrals').textContent = activeReferrals;
    document.getElementById('networkDepth').textContent = maxDepth;
}

function viewUserDetails(userId) {
    // Show modal
    document.getElementById('userDetailsModal').classList.remove('hidden');
    
    // Fetch user details
    fetch(`/api/users/${userId}/details/`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // Update user profile section
            document.getElementById('userDetailsTitle').textContent = `${data.first_name} ${data.last_name}`;
            
            // Profile picture/initials
            const profilePic = document.getElementById('userProfilePic');
            if (data.profile_picture) {
                profilePic.innerHTML = `<img src="${data.profile_picture}" class="w-full h-full rounded-full object-cover">`;
            } else {
                profilePic.textContent = `${data.first_name.charAt(0)}${data.last_name.charAt(0)}`;
            }
            
            // Basic info
            document.getElementById('userName').textContent = `${data.first_name} ${data.last_name}`;
            const statusEl = document.getElementById('userStatus');
            statusEl.textContent = data.status.charAt(0).toUpperCase() + data.status.slice(1);
            statusEl.className = `px-3 py-1 rounded-full text-sm font-semibold ${
                data.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
            }`;
            
            // Dates and codes
            document.getElementById('userJoinDate').textContent = new Date(data.created_at).toLocaleDateString();
            document.getElementById('userReferralCode').textContent = data.referral_code || 'N/A';
            
            // Contact info
            document.getElementById('userPhone').textContent = data.phone || 'N/A';
            document.getElementById('userEmail').textContent = data.email || 'N/A';
            
            // Location info
            document.getElementById('userState').textContent = data.state_name || 'N/A';
            document.getElementById('userDistrict').textContent = data.district_name || 'N/A';
            document.getElementById('userMandal').textContent = data.mandal_name || 'N/A';
            document.getElementById('userVillage').textContent = data.village_name || 'N/A';
            document.getElementById('userPincode').textContent = data.pincode || 'N/A';
            document.getElementById('userAddress').textContent = data.address || 'N/A';
            
            // Referral stats
            document.getElementById('userTotalReferrals').textContent = data.total_referrals || '0';
            document.getElementById('userActiveReferrals').textContent = data.active_referrals || '0';
            document.getElementById('userNetworkDepth').textContent = data.network_depth || '0';
            
            // Update payment information
            // Current Plan Details
            document.getElementById('userCurrentPlan').textContent = data.current_plan?.name || 'No Active Plan';
            document.getElementById('userPlanStartDate').textContent = data.current_plan?.start_date ? new Date(data.current_plan.start_date).toLocaleDateString() : '-';
            document.getElementById('userPlanEndDate').textContent = data.current_plan?.end_date ? new Date(data.current_plan.end_date).toLocaleDateString() : '-';
            
            const planStatus = document.getElementById('userPlanStatus');
            if (data.current_plan?.status) {
                planStatus.textContent = data.current_plan.status.charAt(0).toUpperCase() + data.current_plan.status.slice(1);
                planStatus.className = `px-2 py-1 text-xs font-medium rounded-full ${
                    data.current_plan.status === 'active' ? 'bg-green-100 text-green-800' :
                    data.current_plan.status === 'expired' ? 'bg-red-100 text-red-800' :
                    'bg-gray-100 text-gray-800'
                }`;
            } else {
                planStatus.textContent = 'No Plan';
                planStatus.className = 'px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800';
            }

            // Payment Statistics
            document.getElementById('userTotalPaid').textContent = `₹${data.payment_stats?.total_paid || '0'}`;
            document.getElementById('userLastPayment').textContent = `₹${data.payment_stats?.last_payment_amount || '0'}`;
            document.getElementById('userPaymentDue').textContent = `₹${data.payment_stats?.payment_due || '0'}`;

            // Payment History
            const paymentHistoryContainer = document.getElementById('userPaymentHistory');
            paymentHistoryContainer.innerHTML = '';

            if (data.payment_history && data.payment_history.length > 0) {
                data.payment_history.forEach(payment => {
                    const paymentEl = document.createElement('div');
                    paymentEl.className = 'flex justify-between items-center p-2 bg-white rounded hover:bg-gray-50 transition-colors duration-200';
                    
                    // Format the payment date
                    const paymentDate = new Date(payment.payment_date).toLocaleDateString('en-IN', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                    
                    // Format the payment amount
                    const formattedAmount = new Intl.NumberFormat('en-IN', {
                        style: 'currency',
                        currency: 'INR',
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    }).format(payment.amount);

                    paymentEl.innerHTML = `
                        <div class="flex flex-col">
                            <span class="text-sm font-medium text-gray-900">${payment.plan_name}</span>
                            <span class="text-xs text-gray-500">${paymentDate}</span>
                            <span class="text-xs text-gray-500">${payment.payment_method || 'N/A'}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-medium text-gray-900">${formattedAmount}</span>
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${
                                payment.status === 'success' ? 'bg-green-100 text-green-800' :
                                payment.status === 'failed' ? 'bg-red-100 text-red-800' :
                                payment.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                                'bg-gray-100 text-gray-800'
                            }">${payment.status.charAt(0).toUpperCase() + payment.status.slice(1)}</span>
                            ${payment.transaction_id ? `
                                <span class="text-xs text-gray-500" title="Transaction ID">
                                    #${payment.transaction_id.slice(-6)}
                                </span>
                            ` : ''}
                        </div>
                    `;
                    paymentHistoryContainer.appendChild(paymentEl);
                });
            } else {
                paymentHistoryContainer.innerHTML = `
                    <div class="text-center py-4">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                        </svg>
                        <p class="mt-2 text-sm text-gray-500">No payment history available</p>
                    </div>
                `;
            }

            // Activity timeline
            const timelineContainer = document.getElementById('userActivityTimeline');
            timelineContainer.innerHTML = '';
            
            if (data.activities && data.activities.length > 0) {
                data.activities.forEach(activity => {
                    const activityEl = document.createElement('div');
                    activityEl.className = 'flex items-start space-x-3';
                    activityEl.innerHTML = `
                        <div class="flex-shrink-0">
                            <div class="w-2 h-2 mt-2 rounded-full ${getActivityDotColor(activity.type)}"></div>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-900">${activity.description}</p>
                            <p class="text-sm text-gray-500">${formatActivityDate(activity.timestamp)}</p>
                        </div>
                    `;
                    timelineContainer.appendChild(activityEl);
                });
            } else {
                timelineContainer.innerHTML = '<p class="text-sm text-gray-500">No recent activity</p>';
            }
        })
        .catch(error => {
            console.error('Error fetching user details:', error);
            showToast('Error loading user details. Please try again.', 'error');
        });
}

function closeUserDetailsModal() {
    document.getElementById('userDetailsModal').classList.add('hidden');
}

function getActivityDotColor(type) {
    const colors = {
        'login': 'bg-blue-500',
        'referral': 'bg-green-500',
        'profile_update': 'bg-yellow-500',
        'status_change': 'bg-purple-500',
        'default': 'bg-gray-500'
    };
    return colors[type] || colors.default;
}

function formatActivityDate(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleString();
}

function showReferralTreeFromDepth(userId) {
    // Close the user details modal
    closeUserDetailsModal();
    // Show the referral tree modal
    showReferralTree(userId);
}

function exportToExcel() {
    // Show loading state
    const button = document.querySelector('button[onclick="exportToExcel()"]');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Exporting...';
    button.disabled = true;

    // Create toast notification
    function showToast(message, type = 'error') {
        const toast = document.createElement('div');
        toast.className = `fixed bottom-4 right-4 px-6 py-4 rounded-lg shadow-lg ${
            type === 'error' ? 'bg-red-500' : 'bg-green-500'
        } text-white z-50 animate-fade-in-up`;
        toast.innerHTML = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.classList.add('animate-fade-out-down');
            setTimeout(() => toast.remove(), 500);
        }, 3000);
    }

    // Make the request
    fetch('/export/excel/', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            if (response.headers.get('content-type')?.includes('application/json')) {
                return response.json().then(data => {
                    throw new Error(data.message || 'Error exporting users to Excel');
                });
            }
            throw new Error('Network response was not ok');
        }
        return response.blob();
    })
    .then(blob => {
        // Check if the blob is empty or too small (indicating an error)
        if (blob.size < 100) {
            throw new Error('Invalid Excel file generated');
        }

        // Create a link to download the file
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'normal_users_list.xlsx';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();

        // Show success message
        showToast('Excel file exported successfully!', 'success');

        // Reset button state
        button.innerHTML = originalText;
        button.disabled = false;
    })
    .catch(error => {
        console.error('Error:', error);
        showToast(error.message || 'Error exporting users to Excel. Please try again.');
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function exportToPDF() {
    // Show loading state
    const button = document.querySelector('button[onclick="exportToPDF()"]');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Exporting...';
    button.disabled = true;

    // Make the request
    fetch('/export/pdf/', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            if (response.headers.get('content-type')?.includes('application/json')) {
                return response.json().then(data => {
                    throw new Error(data.message || 'Error exporting users to PDF');
                });
            }
            throw new Error('Network response was not ok');
        }
        return response.blob();
    })
    .then(blob => {
        // Check if the blob is empty or too small (indicating an error)
        if (blob.size < 100) {
            throw new Error('Invalid PDF file generated');
        }

        // Create a link to download the file
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'normal_users_list.pdf';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();

        // Show success message
        showToast('PDF file exported successfully!', 'success');

        // Reset button state
        button.innerHTML = originalText;
        button.disabled = false;
    })
    .catch(error => {
        console.error('Error:', error);
        showToast(error.message || 'Error exporting users to PDF. Please try again.');
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function toggleUserStatus(userId, element) {
    // Show loading state
    const originalText = element.textContent;
    const originalClasses = element.className;
    element.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    element.className = 'cursor-wait px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800';

    // Make API call to toggle status
    fetch(`/api/users/${userId}/toggle-status/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        // Update UI
        const isActive = data.status === 'active';
        element.textContent = isActive ? 'Active' : 'Inactive';
        element.className = `cursor-pointer px-2 inline-flex text-xs leading-5 font-semibold rounded-full transition-colors duration-200 ${
            isActive ? 'bg-green-100 text-green-800 hover:bg-green-200' : 'bg-red-100 text-red-800 hover:bg-red-200'
        }`;

        // Update referral count if needed
        if (data.referral_count !== undefined) {
            const referralCell = element.closest('tr').querySelector('td:nth-child(5)');
            if (referralCell) {
                const referralSpan = referralCell.querySelector('span');
                if (referralSpan) {
                    const newReferralText = `${data.referral_count} ${data.referral_count === 1 ? 'referral' : 'referrals'}`;
                    
                    // Add animation class for smooth transition
                    referralSpan.classList.add('animate-update');
                    
                    // Update text with animation
                    setTimeout(() => {
                        referralSpan.textContent = newReferralText;
                        referralSpan.classList.remove('animate-update');
                    }, 300);

                    // Update click handler and styling based on referral count
                    if (data.referral_count > 0) {
                        referralSpan.classList.add('bg-green-100', 'text-green-800', 'cursor-pointer', 'hover:bg-green-200');
                        referralSpan.classList.remove('bg-gray-100', 'text-gray-600');
                        referralSpan.onclick = () => showReferralTree(userId);
                    } else {
                        referralSpan.classList.add('bg-gray-100', 'text-gray-600');
                        referralSpan.classList.remove('bg-green-100', 'text-green-800', 'cursor-pointer', 'hover:bg-green-200');
                        referralSpan.onclick = null;
                    }
                }
            }
        }

        // Show success toast
        const toast = document.createElement('div');
        toast.className = 'fixed bottom-4 right-4 px-6 py-4 rounded-lg shadow-lg bg-green-500 text-white z-50 animate-fade-in-up';
        toast.innerHTML = `User status changed to ${data.status}`;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.classList.add('animate-fade-out-down');
            setTimeout(() => toast.remove(), 500);
        }, 3000);
    })
    .catch(error => {
        console.error('Error:', error);
        // Restore original state
        element.textContent = originalText;
        element.className = originalClasses;
        
        // Show error toast
        const toast = document.createElement('div');
        toast.className = 'fixed bottom-4 right-4 px-6 py-4 rounded-lg shadow-lg bg-red-500 text-white z-50 animate-fade-in-up';
        toast.innerHTML = 'Error changing user status. Please try again.';
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.classList.add('animate-fade-out-down');
            setTimeout(() => toast.remove(), 500);
        }, 3000);
    });
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Add required CSS for animations
const style = document.createElement('style');
style.textContent = `
    @keyframes fade-in-up {
        from {
            opacity: 0;
            transform: translateY(1rem);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @keyframes fade-out-down {
        from {
            opacity: 1;
            transform: translateY(0);
        }
        to {
            opacity: 0;
            transform: translateY(1rem);
        }
    }
    
    .animate-fade-in-up {
        animation: fade-in-up 0.3s ease-out;
    }
    
    .animate-fade-out-down {
        animation: fade-out-down 0.3s ease-out;
    }
`;
document.head.appendChild(style);

// Add new animation styles
const newStyle = document.createElement('style');
newStyle.textContent = `
    @keyframes fade-in-up {
        from {
            opacity: 0;
            transform: translateY(1rem);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @keyframes fade-out-down {
        from {
            opacity: 1;
            transform: translateY(0);
        }
        to {
            opacity: 0;
            transform: translateY(1rem);
        }
    }
    
    @keyframes update-fade {
        0% {
            opacity: 1;
            transform: scale(1);
        }
        50% {
            opacity: 0.5;
            transform: scale(0.95);
        }
        100% {
            opacity: 1;
            transform: scale(1);
        }
    }
    
    .animate-fade-in-up {
        animation: fade-in-up 0.3s ease-out;
    }
    
    .animate-fade-out-down {
        animation: fade-out-down 0.3s ease-out;
    }
    
    .animate-update {
        animation: update-fade 0.6s ease-in-out;
    }
`;
document.head.appendChild(newStyle);

// Add the delete function to your JavaScript
function deleteUser(userId) {
    // Show confirmation dialog
    const confirmDialog = document.createElement('div');
    confirmDialog.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center animate-fade-in-up';
    confirmDialog.innerHTML = `
        <div class="relative bg-white rounded-lg shadow-xl p-6 max-w-sm w-full mx-4">
            <div class="mb-4">
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Confirm Delete</h3>
                <p class="text-gray-600">Are you sure you want to delete this user? This action cannot be undone.</p>
            </div>
            <div class="flex justify-end space-x-3">
                <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 text-gray-500 hover:text-gray-700 font-medium">
                    Cancel
                </button>
                <button onclick="confirmDelete('${userId}', this)" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 font-medium focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                    <span class="delete-btn-text">Delete User</span>
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(confirmDialog);
}

function confirmDelete(userId, button) {
    // Show loading state
    const btnText = button.querySelector('.delete-btn-text');
    const originalText = btnText.innerHTML;
    btnText.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Deleting...';
    button.disabled = true;

    // Make API call to delete user
    fetch(`/api/users/${userId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.message || 'Error deleting user');
            });
        }
        return response.json();
    })
    .then(data => {
        // Remove the confirmation dialog
        button.closest('.fixed').remove();
        
        // Remove the user row with animation
        const userRow = document.querySelector(`tr[data-user-id="${userId}"]`);
        if (userRow) {
            userRow.style.backgroundColor = '#FEE2E2';
            userRow.style.transition = 'all 0.5s ease';
            setTimeout(() => {
                userRow.style.opacity = '0';
                setTimeout(() => {
                    userRow.remove();
                }, 500);
            }, 100);
        }

        // Show success message
        showToast(data.message || 'User deleted successfully', 'success');
    })
    .catch(error => {
        console.error('Error:', error);
        // Remove the confirmation dialog
        button.closest('.fixed').remove();
        // Show error message
        showToast(error.message || 'Error deleting user. Please try again.', 'error');
    });
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-y-full ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
    } text-white`;
    toast.innerHTML = message;
    document.body.appendChild(toast);
    
    // Animate in
    setTimeout(() => {
        toast.style.transform = 'translateY(0)';
    }, 100);
    
    // Remove after 3 seconds
    setTimeout(() => {
        toast.style.transform = 'translateY(full)';
        toast.style.opacity = '0';
        setTimeout(() => {
            toast.remove();
        }, 300);
    }, 3000);
}
</script>
{% endblock %} 